# Created by Oleksandr Sorochynskyi
# On 26/09/2022

library(tidyverse)
library(lubridate)

bday_dens_raw <- tribble(
    ~days_after_term, ~freq,
    -43.750997615281314, 4.556533125606393,
    -41.28844104392375, 5.81030255819627,
    -34.42849189243437, 9.150103465249572,
    -32.316856950331896, 14.687764338180898,
    -30.96853509455242, 14.243317769738496,
    -29.795924950656868, 14.656939818111482,
    -29.090987292651338, 21.923641212144446,
    -27.978174328192726, 16.346553627496462,
    -27.098444914909983, 18.047637025744507,
    -26.158583792515135, 27.451266194820562,
    -24.809174715291356, 32.57028707425127,
    -23.873829743511322, 18.86412838293137,
    -22.991507725246002, 33.83194184918449,
    -21.819650273119585, 30.393932587491577,
    -20.823588165295895, 27.38603290816212,
    -19.941266147030568, 42.35384637441524,
    -18.94445134743774, 43.197578005151854,
    -17.82971483734689, 47.46354821289469,
    -16.94848004052588, 56.86789423127476,
    -15.830732763358483, 76.54038967928165,
    -14.777047918986462, 68.39626473722694,
    -13.661558717126475, 76.51386625503591,
    -13.07044478109811, 101.32832176019963,
    -11.898921858646865, 96.1784763606995,
    -10.71677761900893, 145.37942833657513,
    -35.01333339705327, 16.43257554396922,
    -36.06935994915149, 12.593847521374073,
    -36.77421397473823, 5.755105161792926,
    -38.94330438855144, 6.209587620490424,
    -39.93903196669996, 10.929323437626977,
    -42.520012043068306, 3.6855612213200857,
    -9.60404828696911, 139.37438171747544,
    -8.78118891846556, 150.0633216885147,
    -7.888078318175943, 220.2378505990471,
    -6.715886336374361, 218.51167747516124,
    -5.712213678440513, 254.44804993094357,
    -4.82704815793624, 283.96647056855716,
    -3.5371017304742196, 284.806617952774,
    -2.825724376221622, 325.02616499959385,
    -1.6497689355743574, 342.5581484260379,
    -0.6563830651520419, 325.8555596442516,
    0.35740911545575216, 413.57497526869906,
    1.58136956449016, 376.7554444704635,
    2.5204779951158756, 382.30744232947353,
    3.344759114738899, 400.27168588619304,
    4.394847765102831, 373.7253224627119,
    5.626167866991011, 374.56618669623276,
    6.443758393110599, 358.29370749681004,
    7.431875421148973, 314.6296995445618,
    8.59746044186592, 279.0947626989855,
    9.530714603176136, 254.68962814637112,
    10.580050561770904, 224.29163341282398,
    11.455681986532795, 205.02272412293493,
    12.510704949605511, 203.72594373210868,
    13.562800778020446, 187.45059713547022,
    14.49229148048498, 143.78730603252592,
    15.603431796567733, 129.6510377588424,
    16.70813241640343, 82.56192383237203,
    17.76240268770701, 77.41351213147982,
    18.579491419313854, 58.57327872534637,
    19.6907153678154, 44.8649694861146,
    20.623969529125603, 20.459834933500304,
    21.620031636949292, 17.451935254170905,
    22.55629656533604, 8.453325941820538,
    23.611068631152364, 5.8726684476390005,
    24.783093348116367, 3.290577254849495,
    25.486692887421214, 3.7099340976540134,
    26.423877772414684, -0.581125835726823,
    27.24489722770481, 0.6927153773734176,
    27.889703176598218, 0.2568710005783146,
    28.651594511801733, -1.036325143728277,
    29.530822130571735, -1.9029959521909063,
    -38.00377779583176, 13.901380651759439,
)

bday_dens_raw %>%
    ggplot(aes(x = days_after_term, y = freq)) +
    geom_line()

bday_dens <- bday_dens_raw %>%
    arrange(days_after_term) %>%
    mutate(
        freq = freq + abs(min(freq)) + 1,
        freq = smooth(freq),
        cum_freq = cumsum(freq) / sum(freq)
    )

bday_dens %>%
    ggplot(aes(x = days_after_term, y = cum_freq)) +
    geom_line()

bday_dens %>%
    ggplot(aes(x = cum_freq, y = days_after_term)) +
    geom_line()

bday_dens %>%
    print(n = 100)

bday_rand <- tibble(
    u = runif(100e3),
    days_after_term = approx(
        x = c(0, bday_dens$cum_freq),
        y = c(min(bday_dens$days_after_term) - 1, bday_dens$days_after_term),
        xout = u,
    )$y,
    bday = ymd("2022-10-10") - weeks(3) + days(round(days_after_term)),
    bday_trunc = pmin(ymd("2022-10-10"), bday)
) %>%
    filter(bday > today())

bday_rand %>%
    ggplot() +
    aes(x = bday) +
    geom_density()

bday_rand %>%
    summarize(
        p_after_10 = mean(bday > ymd("2022-10-10")),
        p_on_29 = mean(bday_trunc == ymd("2022-09-30")),
    )

bday_rand2 %>%
    ggplot() +
    aes(
        x = bday
    ) +
    stat_ecdf()










